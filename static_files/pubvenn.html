<!DOCTYPE html>
<html>
 <head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="http://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css">
<link rel="stylesheet" href="/css/custom.css">
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
<script src="http://d3js.org/d3.v3.js"></script>
<script src="venn.js"></script>
<script src="numeric-1.2.6.min.js"></script>
<script src="mds.js"></script>
<script src="canvg.js"></script>
<script src="rgbcolor.js"></script>
<title>PubVenn: Visual PubMed Search</title>

</head> 
<body>

<div class="container">
      <div class="jumbotron">
        <!--<img src="logo.png">-->
	<h1 id="logo"><span id="pub">Pub</span><span id="venn">Venn</span></h1>
        <a id="about" class="label label-default" href="about.html">About PubVenn</a>		
      </div>

<div class="row">
	<div class="col-sm-6 col-md-7 col-lg-8">
	
		<div class="input-group input-group-lg">
			<input type="text" id="search" class="form-control">
			<span class="input-group-btn">
				<button id="runsearch" class="btn btn-default" type="button">Search</button>
			</span>
			
		</div>
		          <div class="clearfix">
			<div class="detailed">
				<label for="detailed">Expanded subjects</label>
				<input id="detailed" type="checkbox">
			</div>
                               </div>

		<div class="panel panel-default">
			<div class="panel-heading">
				<h3 class="panel-title">Venn Diagram</h3>
			</div>
			<div class="panel-body">
				<div class="venn">
					<p class="vennMsg">Explore PubMed using venn diagrams.<br /> Enter your search above</p>
				</div> 
				<div class="hidden_diagram "></div>				

			</div>
			<div class="diaginfo panel-footer hideMe">Select an area or intersection on the venn diagram to change your search. Double-click to zoom.</div>
			</div>
		
		<div id="past" class="panel panel-default hideMe">
			<div class="panel-heading">
				<h3 class="panel-title">Past searches</h3>
			</div>
			<div class="panel-body">
				<dl></dl>
			</div>
		</div>
	</div>

	<div class="col-sm-6 col-md-5 col-lg-4">
		<div class="panel panel-default">
			<div id="vennresults">
			<div class="panel-heading">
				<div id="translation">
				</div>
			</div>
			<div id="cites" class="panel-body">
				<dl></dl>
			</div>
			<div class="panel-footer"></div>
		</div>
	</div>
	<div id="hidden" class="hideMe"></div>

</div>
</div>

<!--</div>-->

<script>


(function() {
overlapcalls = 0;
var sets = [];
var overlaps = [];
var searches = [];
var termsarray = [];
var search;
var index;
var myOverlap;
var mySet;
var mySearch;
//var lastSearch = "";
var searchCount = 0;
//$("#search").val("");
//$( "#detailed" ).prop( "checked", false );
  
  $("#runsearch").click(function(){
     searchstr = $("#search").val(); 
     startSearch(searchstr); 
   });

   //We have to use event delegation to select the things added after page load...
   $( "#past" ).on( "click", ".pastsearch", function() {
    var searchstr = $( this ).html();
    startSearch(searchstr);
    });

   $( ".venn" ).on( "click", "#getSVGimage", function() {
	getSVGimage();
    });
    
   $( ".venn" ).on( "click", "#getCanvasimage", function() {
	getCanvasimage();
    });

function vennresults (d) {
     if (d.sets.length > 1) {
	var newsearchterms = d.sets.map(function(term) {
		return sets[term].label;
	});
        searchterms = newsearchterms.join(" AND ");
     } else {
	searchterms = d.label;
     }
     esearch(searchterms)
     .done(function( response ) {
     getDocs(response);
      });
}  


function setOverlapSet(slist, sresults) {
    this.sets = slist;
    this.size = Number(sresults);
}

function setSet(slabel, ssize) {
    this.sets = [sets.length];
    this.label = slabel;
    this.size = Number(ssize);
}

function setSearch(sets, terms) {
    this.sets = sets;
    this.terms = terms;
}

function esearch(term) {
     return $.ajax({
	url: 'http://eutils.ncbi.nlm.nih.gov/entrez/eutils/esearch.fcgi',
	data: {
	db: 'pubmed',
	usehistory: 'y',
	term: term,
	retmode: 'json',
	retmax: 0,
	email: 'ed_sperr@hotmail.com',
	tool: 'pubvenn'
	}
     });
}

function getOLCounts() {
	//We do it this way instaed of a loop so we can easily throttle the count requests with setTimeout
	//console.log("Searches: " + JSON.stringify(searches)); 
	mysearch = searches.pop();
	esearch(mysearch.terms) 
	.then(function( data ) {
	myOverlap = new setOverlapSet(mysearch.sets,data.esearchresult.count);
	sets.push(myOverlap);
	if (searches.length) {
		setTimeout(getOLCounts, 300);
	} else {
		drawVennDiagram ();
		}
	});
}

function getOverlaps() {
var results;
var overlapcount = 0;

for (index = 0; index < sets.length; index++) {
     for (j = index; j < (sets.length - 1); j++) {
         search = sets[index].label + " AND " + sets[j+1].label
	 //send sets and terms to our temporary 'search' object
	 mySearch = new setSearch([index,(j+1)], search);  
         searches.push(mySearch);
       } 
   }

var totalsets = searches.length + sets.length;
getOLCounts();

}

function getSimpleSets(termsarray, possibles) {
 $.each(termsarray, function (i, term) {
     esearch(termsarray[i])
     .then(function( data ) {
	var numResults = Number(data.esearchresult.count);
	if (numResults != 0) {
		mySet = new setSet(termsarray[i], numResults);
		sets.push(mySet);
	} 
    if (sets.length >= possibles) { getOverlaps(); }    	
     });
 
    });
}

function getDocs(data) {
     var query_key = data.esearchresult.querykey;
     var WebEnv = data.esearchresult.webenv;
     var translation = data.esearchresult.querytranslation;
     var esummaryURL = "http://eutils.ncbi.nlm.nih.gov/entrez/eutils/esummary.fcgi";
     $("#translation").empty();
     $("#translation").append(translation.replace(/"/g, "") + ": " + data.esearchresult.count);
     $("#vennresults dl").empty(); 
     
     $.getJSON( esummaryURL, {
     db: 'pubmed',
     usehistory: 'y',
     WebEnv: WebEnv,
     query_key: query_key,
     retmode: 'json',
     retmax: '10'
     })
     .done(function( response ) {
     
     //result = response.result[25318114] instead of .dot notation -- probably should refactor this using $.each
     result = response.result;
     var uids = result.uids;
     var  i = 0;
     while (i < uids.length) {
         $("#vennresults dl").append("<dt>" + '<a href="http://www.ncbi.nlm.nih.gov/pubmed/' + result[uids[i]].uid + '">' + result[uids[i]].title + '</a></dt>');
	var names = [];
	var a = 0;
	while (a < result[uids[i]].authors.length) {
	     names.push(result[uids[i]].authors[a].name);
	     a++;
        }
        var cite = names.join(", "); 
	cite += "<br />" + result[uids[i]].source + ". " + result[uids[i]].pubdate
	if (result[uids[i]].volume) { cite += ";" + result[uids[i]].volume; } 
	if (result[uids[i]].issue) { cite += "(" + result[uids[i]].issue + ")"; } 
	if (result[uids[i]].pages) { cite += ":" + result[uids[i]].pages; } 
	cite += ".";
	 $("#vennresults dl").append("<dd>" + cite + "</dd>");
	i++;	
     }
    
    $("#vennresults .panel-footer").empty();
    $("#vennresults .panel-footer").append('See <a href="http://www.ncbi.nlm.nih.gov/pubmed/?term=' + translation.replace(/"/g, "%22") + '">more results on PubMed</a>');  
      }); 
 
}

function startSearch(term) {
    //clear the decks	
    $(".venn").empty();
    $(".vennresults").empty();
    while (sets.length) { sets.pop(); }
    while (searches.length) { searches.pop(); }
    while (overlaps.length) { overlaps.pop(); }
    
    if (searchCount>0) { $( "#past" ).removeClass( "hideMe" ); }
    $( "#past dt" ).last().removeClass( "hideMe" );
    $("#past dl").append('<dt class="pastsearch hideMe">' + term + "</dt>");
    searchCount++;

     $( ".venn" ).append("<div class='vennMsg'><p>Loading your diagram. Please wait...</p><img src='loading-bars.svg'></div> ")
     esearch(term)
     .then(function( data ) {
	getDocs(data);
        var numResults = Number(data.esearchresult.count);
	var translation = data.esearchresult.querytranslation;
	if (numResults == 0) { 
	        $(".venn").empty();
		document.getElementById("translation").innerHTML = '<div class="alert alert-danger" role="alert">Nothing found for this search. Please try again</div>.';
		$("#cites dl").empty();
	} else if (data.esearchresult.translationset.length < 1) {
		$(".venn").empty();
		//do something to telll them there's no drawing coming...
		$(".venn").append("<p class='vennMsg'>Only one term found. No diagram shown...</p>");
	} else {
		//document.getElementById("translation").innerHTML = "<p>Pubmed translated your search to :" + translation + "</p>";
		//$("#translation").append("<p>" + numResults + " citations were found</p>"); 
	}
	
	if (!detailed.checked ) {
		var termsarray = term.split(/ and | or | not /i);
		var possibleTerms = termsarray.length;
		if (data.esearchresult.errorlist) {
			possibleTerms = possibleTerms - Number(data.esearchresult.errorlist.phrasesnotfound.length);
		}		
		if (possibleTerms<2) {
			$(".venn").empty();
			$(".venn").append('<p class="vennMsg">Only one valid term entered. Enter more terms or choose "expanded subjects"</p>');
		} else {
			getSimpleSets(termsarray, possibleTerms);			
		}
	} else {
		$.each( data.esearchresult.translationstack, function( i, item ) {
			if(typeof item == "object") { 
				mySet = new setSet(item.term, item.count);  
				sets.push(mySet);
			}	    
		});
		getOverlaps();
	}
}).fail(function() {
    alert("Search failed");
});
}



function drawVennDiagram () {
$(".venn").empty();
var currentwidth = $(".venn").innerWidth();
console.log(currentwidth);

var zoom = d3.behavior.zoom()
    .translate([0, 0])
    .scale(1)
    .scaleExtent([1, 8])
    .on("zoom", zoomed);
    
var chart = venn.VennDiagram()
                 .width(currentwidth)
                 .height(currentwidth)
		 //include this for MD5 layout -- supposedly better, but some weird (broken) edge cases...
		.layoutFunction(
                    function(d) { return venn.venn(d, { initialLayout: venn.classicMDSLayout });}
                );

var div = d3.select(".venn")
div.datum(sets).call(chart);

var fixtext = d3.selectAll("text")
         .attr("font-size","1.25em");	
	 
var svg = d3.select("svg").call(zoom);

var tooltip = d3.select("body").append("div")
    .attr("class", "venntooltip");

div.selectAll("path")
    .style("stroke-opacity", 0)
    .style("stroke", "#fff")
    .style("stroke-width", 0)

div.selectAll("g")
    .on("mouseover", function(d, i) {
        // sort all the areas relative to the current item
        venn.sortAreas(div, d);

        // Display a tooltip with the current size
        tooltip.transition().duration(400).style("opacity", .9);
        tooltip.text(d.size + " citations");
        
        // highlight the current path
        var selection = d3.select(this).transition("tooltip").duration(400);
        selection.select("path")
            .style("stroke-width", 3)
            .style("fill-opacity", d.sets.length == 1 ? .4 : .1)
            .style("stroke-opacity", 1);
    })

    .on("mousemove", function() {
        tooltip.style("left", (d3.event.pageX) + "px")
               .style("top", (d3.event.pageY - 28) + "px");
    })
    
    .on("mouseout", function(d, i) {
        tooltip.transition().duration(400).style("opacity", 0);
        var selection = d3.select(this).transition("tooltip").duration(400);
        selection.select("path")
            .style("stroke-width", 0)
            .style("fill-opacity", d.sets.length == 1 ? .25 : .0)
            .style("stroke-opacity", 0);
    })
    
     .on("click", function(d, i) {
        //console.log(JSON.stringify(d));
        vennresults(d);      
    });


function zoomed() {
  svg.attr("transform", "translate(" + d3.event.translate + ")scale(" + d3.event.scale + ")");
}

var setid = d3.select("svg").attr("id","venn");

$( ".diaginfo" ).removeClass( "hideMe" ); 

$(".venn").append('<p>View/Download <a id="getSVGimage" href="#">SVG</a> | <a id="getCanvasimage" href="#">PNG</a></p>');
}

function getSVGimage () {
    //The new API kills things when you draw it a second time, so for the time being, we just grab the original diagram
    //$(".hidden_diagram").empty();
    //var brandstr = 'PubMed citation sets for  "' + searchstr + '"';
    
    /* 
    var fixtext = d3.selectAll("text")
       .attr("font-family","sans-serif");
   
    var brandme = d3.select('.hidden_diagram svg')
         .attr("id","hidden_one") 
        .append("text")
	.text(brandstr)
        .attr("x", "20")
	.attr("y", "20");
     */	
     	
    //use d3 to grab our new diagram and pass it through the serializer -- then create a data_uri (or you could just do document.getElementsByTagName("svg")[0];) 
     
     var xml = d3.select("svg")
	.attr("title", "test2")
	.attr("version", 1.1)
	.attr("xmlns", "http://www.w3.org/2000/svg").node();
	
     var fixtext = d3.selectAll("text")
         .attr("font-family","sans-serif");	

    var xmlString = (new XMLSerializer).serializeToString(xml);      
    var data_uri = "data:image/svg+xml;base64," + window.btoa(xmlString);   
    // or "data:image/svg+xml," + encodeURIComponent(xmlString));
    window.open(data_uri);
    }
        //implicitly call a data_uri -- maybe safari will like it better?
	//
//another canvas attempt

function getCanvasimage () {
     var xml = d3.select("svg")
	.attr("title", "test2")
	.attr("version", 1.1)
	.attr("xmlns", "http://www.w3.org/2000/svg").node();

    var xmlString = (new XMLSerializer).serializeToString(xml);     
    var canvas = document.createElement("canvas");
    canvas.width = 700;
    canvas.height = 700;
    var context = canvas.getContext("2d");
    context.clearRect(0, 0, 700, 700);

    canvg(canvas, xmlString, { ignoreAnimation: true });
    document.location.href = canvas.toDataURL(); 
}

})
();






</script>



</body>
</html>