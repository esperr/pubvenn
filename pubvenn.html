<!DOCTYPE html>
<html>
 <head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="http://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css">
<link rel="stylesheet" href="custom.css">
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
<script src="http://d3js.org/d3.v3.min.js"></script>
<script src="venn.js"></script>
<script src="svg-pan-zoom.js"></script>
<script src="numeric-1.2.6.min.js"></script>
<script src="mds.js"></script>
<title>PubVenn: Visual PubMed Search</title>

</head> 
<body>

<div class="container">
      <div class="jumbotron">
        <h1>PubVenn</h1>      
        <p>Explore your PubMed search with Venn diagrams!</p> 
        <a id="about" class="label label-default" href="about.html">About PubVenn</a>		
      </div>

<div class="row">
	<div class="col-sm-7 col-md-7 col-lg-7">
	
		<div class="input-group input-group-lg">
			<input type="text" id="search" class="form-control">
			<span class="input-group-btn">
				<button id="runsearch" class="btn btn-default" type="button">Search</button>
			</span>
			
		</div>
			<div class="detailed">
				<label for="detailed">Detailed view</label>
				<input id="detailed" type="checkbox">
			</div>


		<div class="panel panel-default">
			<div class="panel-heading">
				<h3 class="panel-title">Venn Diagram</h3>
			</div>
			<div class="panel-body">
				<div class="venn">
					<p class="vennMsg">Enter your PubMed search above</p>
				</div> 
				<div class="hidden_diagram "></div>				

			</div>
			<div class="diaginfo panel-footer hideMe">Select an area or intersection on the venn diagram to change your search&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
			<button id="ztrigger" type="button" class="btn btn-default">Zoom</button></div>
		</div>
		
		<div id="past" class="panel panel-default hideMe">
			<div class="panel-heading">
				<h3 class="panel-title">Past searches</h3>
			</div>
			<div class="panel-body">
				<dl></dl>
			</div>
		</div>
	</div>

	<div class="col-sm-5 col-md-5 col-lg-5">
		<div class="panel panel-default">
			<div id="vennresults">
			<div class="panel-heading">
				<div id="translation">
				</div>
			</div>
			<div id="cites" class="panel-body">
				<dl></dl>
			</div>
			<div class="panel-footer"></div>
		</div>
	</div>
	<div id="hidden" class="hideMe"></div>

</div>
</div>

<!--</div>-->

<script>


(function() {
overlapcalls = 0;
var sets = [];
var overlaps = [];
var searches = [];
var termsarray = [];
var search;
var index;
var myOverlap;
var mySet;
var mySearch;
//var lastSearch = "";
var searchCount = 0;
//$("#search").val("");
//$( "#detailed" ).prop( "checked", false );
  
  $("#runsearch").click(function(){
     searchstr = $("#search").val(); 
     startSearch(searchstr); 
   });

   //We have to use event delegation to select the things added after page load...
   $( "#past" ).on( "click", ".pastsearch", function() {
    var searchstr = $( this ).html();
    startSearch(searchstr);
    });

   $( ".venn" ).on( "click", "#getDLimage", function() {
	getDLimage();
    });

function vennresults (d) {
     if (d.sets.length > 1) {
	console.log(d.sets);
	var newsearchterms = d.sets.map(function(term) {
		return sets[term].label;
	});
	console.log(newsearchterms);
        searchterms = newsearchterms.join(" AND ");
     } else {
	searchterms = d.label;
     }
     esearch(searchterms)
     .done(function( response ) {
     getDocs(response);
      });
}  


function setOverlapSet(slist, sresults) {
    this.sets = slist;
    this.size = Number(sresults);
}

function setSet(slabel, ssize) {
    this.sets = [sets.length];
    this.label = slabel;
    this.size = Number(ssize);
}

function setSearch(sets, terms) {
    this.sets = sets;
    this.terms = terms;
}

function esearch(term) {
     return $.ajax({
	url: 'http://eutils.ncbi.nlm.nih.gov/entrez/eutils/esearch.fcgi',
	data: {
	db: 'pubmed',
	usehistory: 'y',
	term: term,
	retmode: 'json',
	retmax: 0,
	email: 'ed_sperr@hotmail.com',
	tool: 'pubvenn'
	}
     });
}

function getOLCounts() {
	//We do it this way instaed of a loop so we can easily throttle the count requests with setTimeout
	//console.log("Searches: " + JSON.stringify(searches)); 
	mysearch = searches.pop();
	esearch(mysearch.terms) 
	.then(function( data ) {
	myOverlap = new setOverlapSet(mysearch.sets,data.esearchresult.count);
	sets.push(myOverlap);
	if (searches.length) {
		setTimeout(getOLCounts, 300);
	} else {
		drawVennDiagram ();
	}
	});
}

function getOverlaps() {
var results;
var overlapcount = 0;

for (index = 0; index < sets.length; index++) {
     for (j = index; j < (sets.length - 1); j++) {
         search = sets[index].label + " AND " + sets[j+1].label
	 //send sets and terms to our temporary 'search' object
	 mySearch = new setSearch([index,(j+1)], search);  
         searches.push(mySearch);
       } 
   }

var totalsets = searches.length + sets.length;
getOLCounts();

}

function getSimpleSets(termsarray, possibles) {
 $.each(termsarray, function (i, term) {
     esearch(termsarray[i])
     .then(function( data ) {
	var numResults = Number(data.esearchresult.count);
	if (numResults != 0) {
		mySet = new setSet(termsarray[i], numResults);
		sets.push(mySet);
	} 
    if (sets.length >= possibles) { getOverlaps(); }    	
     });
 
    });
}

function getDocs(data) {
     //if detailed checked, do all the below, otherwise, just pass the search and get the number? 	
     var query_key = data.esearchresult.querykey;
     var WebEnv = data.esearchresult.webenv;
     var translation = data.esearchresult.querytranslation;
     var esummaryURL = "http://eutils.ncbi.nlm.nih.gov/entrez/eutils/esummary.fcgi";
     $("#translation").empty();
     $("#translation").append(translation.replace(/"/g, "") + ": " + data.esearchresult.count);
     $("#vennresults dl").empty(); 
     
     $.getJSON( esummaryURL, {
     db: 'pubmed',
     usehistory: 'y',
     WebEnv: WebEnv,
     query_key: query_key,
     retmode: 'json',
     retmax: '10'
     })
     .done(function( response ) {
     
     //result = response.result[25318114] instead of .dot notation -- probably should refactor this using $.each
     result = response.result;
     var uids = result.uids;
     var  i = 0;
     while (i < uids.length) {
         $("#vennresults dl").append("<dt>" + '<a href="http://www.ncbi.nlm.nih.gov/pubmed/' + result[uids[i]].uid + '">' + result[uids[i]].title + '</a></dt>');
	var names = [];
	var a = 0;
	while (a < result[uids[i]].authors.length) {
	     names.push(result[uids[i]].authors[a].name);
	     a++;
        }
        var cite = names.join(", "); 
	cite += "<br />" + result[uids[i]].source + ". " + result[uids[i]].pubdate
	if (result[uids[i]].volume) { cite += ";" + result[uids[i]].volume; } 
	if (result[uids[i]].issue) { cite += "(" + result[uids[i]].issue + ")"; } 
	if (result[uids[i]].pages) { cite += ":" + result[uids[i]].pages; } 
	cite += ".";
	 $("#vennresults dl").append("<dd>" + cite + "</dd>");
	i++;	
     }
    
    $("#vennresults .panel-footer").empty();
    $("#vennresults .panel-footer").append('See <a href="http://www.ncbi.nlm.nih.gov/pubmed/?term=' + translation.replace(/"/g, "%22") + '">more results on PubMed</a>');  
      }); 
 
}

function startSearch(term) {
    //clear the decks	
    $(".venn").empty();
    $(".vennresults").empty();
    while (sets.length) { sets.pop(); }
    while (searches.length) { searches.pop(); }
    while (overlaps.length) { overlaps.pop(); }
    
    if (searchCount>0) { $( "#past" ).removeClass( "hideMe" ); }
    $( "#past dt" ).last().removeClass( "hideMe" );
    $("#past dl").append('<dt class="pastsearch hideMe">' + term + "</dt>");
    searchCount++;

     $( ".venn" ).append("<div class='vennMsg'><p>Loading your diagram. Please wait...</p><img src='loading-bars.svg'></div> ")
     esearch(term)
     .then(function( data ) {
	getDocs(data);
        var numResults = Number(data.esearchresult.count);
	var translation = data.esearchresult.querytranslation;
	if (numResults == 0) { 
	        $(".venn").empty();
		document.getElementById("translation").innerHTML = '<div class="alert alert-danger" role="alert">Nothing found for this search. Please try again</div>.';
		$("#cites dl").empty();
	} else if (data.esearchresult.translationset.length < 1) {
		$(".venn").empty();
		//do something to telll them there's no drawing coming...
		$(".venn").append("<p class='vennMsg'>Only one term found. No diagram shown...</p>");
	} else {
		//document.getElementById("translation").innerHTML = "<p>Pubmed translated your search to :" + translation + "</p>";
		//$("#translation").append("<p>" + numResults + " citations were found</p>"); 
	}
	
	if (!detailed.checked ) {
		var termsarray = term.split(/ and | or | not /i);
		var possibleTerms = termsarray.length;
		if (data.esearchresult.errorlist) {
			possibleTerms = possibleTerms - Number(data.esearchresult.errorlist.phrasesnotfound.length);
		}		
		if (possibleTerms<2) {
			$(".venn").empty();
			$(".venn").append('<p class="vennMsg">Only one valid term entered. Enter more terms or choose "detailed" to show venn diagram.</p>');
		} else {
			getSimpleSets(termsarray, possibleTerms);			
		}
	} else {
		$.each( data.esearchresult.translationstack, function( i, item ) {
			if(typeof item == "object") { 
				mySet = new setSet(item.term, item.count);  
				sets.push(mySet);
			}	    
		});
		getOverlaps();
	}
}).fail(function() {
    alert("Search failed");
});
}

//trigger zoom

  //$( ".venn" ).on( "click", "button", function() {
  $("#ztrigger").click(function(){
  $( "#ztrigger" ).addClass( "hideMe" )
       var nukeviewbox = d3.select("svg")
       .attr("viewbox",null)
       .attr("width","500")
       .attr("height","500");    
  
        svgPanZoom('#venn', {
          zoomEnabled: true,
          controlIconsEnabled: true,
          fit: true,
          center: true
   });
    });   

function drawVennDiagram () {
$(".venn").empty();

var chart = venn.VennDiagram()
                 .width(500)
                 .height(500)   
		 .layoutFunction(
                    function(d) { return venn.venn(d, { initialLayout: venn.classicMDSLayout });}
                );

var div = d3.select(".venn")
div.datum(sets).call(chart);

var tooltip = d3.select("body").append("div")
    .attr("class", "venntooltip");

div.selectAll("path")
    .style("stroke-opacity", 0)
    .style("stroke", "#fff")
    .style("stroke-width", 0)

div.selectAll("g")
    .on("mouseover", function(d, i) {
        // sort all the areas relative to the current item
        venn.sortAreas(div, d);

        // Display a tooltip with the current size
        tooltip.transition().duration(400).style("opacity", .9);
        tooltip.text(d.size + " citations");
        
        // highlight the current path
        var selection = d3.select(this).transition("tooltip").duration(400);
        selection.select("path")
            .style("stroke-width", 3)
            .style("fill-opacity", d.sets.length == 1 ? .4 : .1)
            .style("stroke-opacity", 1);
    })

    .on("mousemove", function() {
        tooltip.style("left", (d3.event.pageX) + "px")
               .style("top", (d3.event.pageY - 28) + "px");
    })
    
    .on("mouseout", function(d, i) {
        tooltip.transition().duration(400).style("opacity", 0);
        var selection = d3.select(this).transition("tooltip").duration(400);
        selection.select("path")
            .style("stroke-width", 0)
            .style("fill-opacity", d.sets.length == 1 ? .25 : .0)
            .style("stroke-opacity", 0);
    })
    
     .on("click", function(d, i) {
        //console.log(JSON.stringify(d));
        vennresults(d);      
    });
  
//set ourselves a handle for the SVG diagram and make it responsive instead of fixed
var setid = d3.select("svg").attr("id","venn")   
			.attr("width", null)
                	.attr("height", null)
			.attr("viewBox", "0 0 500 500")
			.attr("preserveAspectRatio", "xMinYMin meet")
			.attr("class", "svg-content");


$( ".diaginfo" ).removeClass( "hideMe" ); 
$(".venn").append('<a id="getDLimage" href="#">View/Download image</a>');
}

function getDLimage () {
    //The new API kills things when you sraw it a second time, so for the time being, we just grab the original diagram
    //$(".hidden_diagram").empty();
    //var brandstr = 'PubMed citation sets for  "' + searchstr + '"';
    
    /* 
    var fixtext = d3.selectAll("text")
       .attr("font-family","sans-serif");
   
    var brandme = d3.select('.hidden_diagram svg')
         .attr("id","hidden_one") 
        .append("text")
	.text(brandstr)
        .attr("x", "20")
	.attr("y", "20");
     */	
     	
    //use d3 to grab our new diagram and pass it through the serializer -- then create a data_uri
    //var xmlString = (new XMLSerializer).serializeToString(d3.select('.hidden_diagram svg')); 
     //var svg = $('.hidden_diagram').find('svg')[0];  
     var svg = document.getElementById('venn');     
     var xmlString = (new XMLSerializer).serializeToString(svg);      
     var data_uri = "data:image/svg+xml;base64," + window.btoa(xmlString);   
    
    //we could just pass the string to a data_uri and open a new window   
    window.open(data_uri);
    
    //...or we could try using a html5 canvas here to convert it to a PNG and make saving it more obvious
    //TEST on Safari and Chrome
    /*
    var image = new Image;
    image.src = data_uri;
    image.onload = function(e) {
    
        var canvas = document.createElement("canvas");
        canvas.width = image.width;
        canvas.height = image.height;

        var context = canvas.getContext("2d");
        context.clearRect(0, 0, image.width, image.height);
        context.drawImage(image, 0, 0);

        var a = document.createElement("a");
        a.download = "file.png";
        a.href = canvas.toDataURL("image/png");
	window.open(a.href);

        //$(".venn .panel-footer").append('<a href="' + a.href + '">View/Save Image</a>');
	}
  	*/

  
//myCanvas = document.createElement('canvas');    
//var ctx = myCanvas.getContext('2d');
//var img = new Image;
//give the source *after* we call our onload function?
//img.onload = function(){ ctx.drawImage(img,0,0); };
//img.src = "data:image/svg+xml;base64,"+btoa(xmlString);    
        

}

})
();






</script>



</body>
</html>